#!/usr/bin/env python3
"""
workspaceconfig - ThinkPad Cyberpunk Workspace Configuration TUI
Interactive configuration tool for workspace app launcher
"""

import sys
import json
import curses
import subprocess
from pathlib import Path
from typing import Dict, List, Optional, Tuple

sys.path.insert(0, str(Path(__file__).parent.parent / "lib"))

from colors import Colors

# Configuration paths
CONFIG_DIR = Path.home() / ".config" / "thinkpad-cyberpunk"
CONFIG_FILE = CONFIG_DIR / "workspaces.json"

# Default configuration (same as workspacelaunch)
DEFAULT_CONFIG = {
    "workspaces": {
        "1": {"name": "TERM", "layout": "split-h", "apps": []},
        "2": {"name": "CODE", "apps": []},
        "3": {"name": "WEB", "apps": []},
        "4": {"name": "FILES", "apps": []},
        "5": {"name": "MEDIA", "apps": []},
        "6": {"name": "COMM", "apps": []},
        "7": {"name": "MISC", "apps": []},
        "8": {"name": "GAME", "apps": []},
        "9": {"name": "MONITOR", "apps": []},
        "10": {"name": "SYS", "apps": []}
    },
    "shortcuts": {}
}


class WorkspaceConfigUI:
    """TUI for configuring workspace launchers"""

    def __init__(self, stdscr):
        self.stdscr = stdscr
        self.config = self.load_config()
        self.current_workspace = "1"
        self.selected_item = 0
        self.mode = "main"  # main, edit_workspace, edit_app, edit_shortcut

        # Initialize colors
        curses.init_pair(1, curses.COLOR_CYAN, curses.COLOR_BLACK)
        curses.init_pair(2, curses.COLOR_MAGENTA, curses.COLOR_BLACK)
        curses.init_pair(3, curses.COLOR_GREEN, curses.COLOR_BLACK)
        curses.init_pair(4, curses.COLOR_YELLOW, curses.COLOR_BLACK)
        curses.init_pair(5, curses.COLOR_RED, curses.COLOR_BLACK)

        self.COLOR_CYAN = curses.color_pair(1)
        self.COLOR_MAGENTA = curses.color_pair(2)
        self.COLOR_GREEN = curses.color_pair(3)
        self.COLOR_YELLOW = curses.color_pair(4)
        self.COLOR_RED = curses.color_pair(5)

    def load_config(self) -> Dict:
        """Load configuration from file"""
        if not CONFIG_FILE.exists():
            return DEFAULT_CONFIG.copy()

        try:
            with open(CONFIG_FILE) as f:
                return json.load(f)
        except json.JSONDecodeError:
            return DEFAULT_CONFIG.copy()

    def save_config(self):
        """Save configuration to file"""
        CONFIG_DIR.mkdir(parents=True, exist_ok=True)
        with open(CONFIG_FILE, 'w') as f:
            json.dump(self.config, f, indent=2)

    def get_input(self, prompt: str, default: str = "") -> Optional[str]:
        """Get text input from user"""
        curses.echo()
        curses.curs_set(1)

        height, width = self.stdscr.getmaxyx()
        y = height - 3

        self.stdscr.addstr(y, 2, " " * (width - 4))
        self.stdscr.addstr(y, 2, prompt, self.COLOR_CYAN)
        self.stdscr.addstr(y + 1, 2, " " * (width - 4))

        if default:
            self.stdscr.addstr(y + 1, 2, default)

        self.stdscr.refresh()

        try:
            input_str = self.stdscr.getstr(y + 1, 2 + len(default), 60).decode('utf-8')
            result = default + input_str if default else input_str
        except KeyboardInterrupt:
            result = None

        curses.noecho()
        curses.curs_set(0)

        return result if result else None

    def show_message(self, message: str, color=None):
        """Show a message at the bottom of screen"""
        if color is None:
            color = self.COLOR_GREEN

        height, width = self.stdscr.getmaxyx()
        y = height - 2

        self.stdscr.addstr(y, 2, " " * (width - 4))
        self.stdscr.addstr(y, 2, message[:width - 4], color)
        self.stdscr.refresh()
        curses.napms(1500)

    def draw_header(self):
        """Draw the header"""
        self.stdscr.addstr(0, 2, "╔═══════════════════════════════════════════════════════════╗", self.COLOR_CYAN | curses.A_BOLD)
        self.stdscr.addstr(1, 2, "║  WORKSPACE CONFIGURATION - CYBERPUNK EDITION             ║", self.COLOR_MAGENTA | curses.A_BOLD)
        self.stdscr.addstr(2, 2, "╚═══════════════════════════════════════════════════════════╝", self.COLOR_CYAN | curses.A_BOLD)

    def draw_main_menu(self):
        """Draw the main configuration menu"""
        height, width = self.stdscr.getmaxyx()

        y = 4
        self.stdscr.addstr(y, 2, "Workspace Configuration", self.COLOR_CYAN | curses.A_BOLD)
        y += 2

        # List workspaces
        for i, (ws_id, ws_config) in enumerate(sorted(self.config["workspaces"].items())):
            name = ws_config.get("name", "Unnamed")
            apps = ws_config.get("apps", [])
            app_count = len(apps)

            if i == self.selected_item:
                attr = self.COLOR_MAGENTA | curses.A_REVERSE
            else:
                attr = self.COLOR_CYAN

            line = f" [{ws_id:2s}] {name:12s} - {app_count} app{'s' if app_count != 1 else ''} "
            self.stdscr.addstr(y, 4, line[:width - 6], attr)
            y += 1

            # Show apps for selected workspace
            if i == self.selected_item:
                for app in apps:
                    cmd = app.get("command", "")[:width - 15]
                    pos = app.get("position", "default")
                    self.stdscr.addstr(y, 8, f"→ {cmd}", self.COLOR_YELLOW)
                    if pos != "default":
                        self.stdscr.addstr(y, width - 20, f"[{pos}]", self.COLOR_GREEN)
                    y += 1

        # Draw help
        y = height - 6
        self.stdscr.addstr(y, 2, "─" * (width - 4), self.COLOR_CYAN)
        y += 1
        self.stdscr.addstr(y, 2, "↑/↓: Navigate  ", self.COLOR_GREEN)
        self.stdscr.addstr(y, 18, "ENTER: Edit workspace  ", self.COLOR_GREEN)
        self.stdscr.addstr(y, 42, "a: Add app  ", self.COLOR_GREEN)
        y += 1
        self.stdscr.addstr(y, 2, "d: Delete app  ", self.COLOR_GREEN)
        self.stdscr.addstr(y, 18, "s: Edit shortcuts  ", self.COLOR_GREEN)
        self.stdscr.addstr(y, 42, "q: Quit & Save", self.COLOR_GREEN)

    def edit_workspace(self):
        """Edit workspace settings"""
        ws_list = sorted(self.config["workspaces"].keys())
        if self.selected_item >= len(ws_list):
            return

        ws_id = ws_list[self.selected_item]
        ws_config = self.config["workspaces"][ws_id]

        self.stdscr.clear()
        self.draw_header()

        y = 4
        self.stdscr.addstr(y, 2, f"Editing Workspace {ws_id}", self.COLOR_CYAN | curses.A_BOLD)
        y += 2

        # Edit name
        self.stdscr.addstr(y, 4, f"Name: {ws_config.get('name', '')}", self.COLOR_YELLOW)
        y += 1
        self.stdscr.addstr(y, 4, f"Layout: {ws_config.get('layout', 'default')}", self.COLOR_YELLOW)
        y += 2

        self.stdscr.addstr(y, 4, "Apps:", self.COLOR_YELLOW)
        y += 1

        apps = ws_config.get("apps", [])
        for i, app in enumerate(apps):
            cmd = app.get("command", "")
            pos = app.get("position", "default")
            self.stdscr.addstr(y, 6, f"{i+1}. {cmd} [{pos}]", self.COLOR_CYAN)
            y += 1

        self.stdscr.refresh()

        # Menu
        choice = self.get_input("(n)ame, (l)ayout, (a)dd app, (d)elete app, or ENTER to return: ")

        if choice == 'n':
            new_name = self.get_input("Workspace name: ", ws_config.get('name', ''))
            if new_name:
                ws_config['name'] = new_name
                self.show_message("Workspace name updated!")

        elif choice == 'l':
            layout = self.get_input("Layout (default/split-h/split-v/tabbed/stacking): ",
                                   ws_config.get('layout', 'default'))
            if layout:
                ws_config['layout'] = layout
                self.show_message("Layout updated!")

        elif choice == 'a':
            self.add_app(ws_id)

        elif choice == 'd':
            app_num = self.get_input("App number to delete: ")
            if app_num and app_num.isdigit():
                idx = int(app_num) - 1
                if 0 <= idx < len(apps):
                    apps.pop(idx)
                    self.show_message("App deleted!")

    def add_app(self, ws_id: str):
        """Add an application to workspace"""
        command = self.get_input("Application command: ")
        if not command:
            return

        position = self.get_input("Position (default/left/right/top/bottom/right-top/right-bottom): ", "default")
        if not position:
            position = "default"

        ws_config = self.config["workspaces"][ws_id]
        if "apps" not in ws_config:
            ws_config["apps"] = []

        ws_config["apps"].append({
            "command": command,
            "position": position
        })

        self.show_message("App added!")

    def edit_shortcuts(self):
        """Edit keyboard shortcuts"""
        self.stdscr.clear()
        self.draw_header()

        y = 4
        self.stdscr.addstr(y, 2, "Keyboard Shortcuts", self.COLOR_CYAN | curses.A_BOLD)
        y += 2

        shortcuts = self.config.get("shortcuts", {})
        for shortcut, ws_id in sorted(shortcuts.items()):
            ws_name = self.config["workspaces"].get(ws_id, {}).get("name", "Unknown")
            self.stdscr.addstr(y, 4, f"{shortcut:25s} → Workspace {ws_id} ({ws_name})", self.COLOR_YELLOW)
            y += 1

        y += 1
        self.stdscr.addstr(y, 4, "Common modifiers: Mod4 (Super/Windows key), Ctrl, Shift, Alt", self.COLOR_GREEN)
        y += 1
        self.stdscr.addstr(y, 4, "Example: Mod4+Ctrl+1", self.COLOR_GREEN)

        self.stdscr.refresh()

        choice = self.get_input("(a)dd shortcut, (d)elete shortcut, or ENTER to return: ")

        if choice == 'a':
            shortcut = self.get_input("Shortcut (e.g., Mod4+Ctrl+1): ")
            if shortcut:
                ws_id = self.get_input("Workspace ID (1-10): ")
                if ws_id and ws_id in self.config["workspaces"]:
                    self.config["shortcuts"][shortcut] = ws_id
                    self.show_message("Shortcut added!")
                else:
                    self.show_message("Invalid workspace ID!", self.COLOR_RED)

        elif choice == 'd':
            shortcut = self.get_input("Shortcut to delete: ")
            if shortcut and shortcut in shortcuts:
                del self.config["shortcuts"][shortcut]
                self.show_message("Shortcut deleted!")

    def run(self):
        """Main UI loop"""
        curses.curs_set(0)
        self.stdscr.clear()

        while True:
            self.stdscr.clear()
            self.draw_header()
            self.draw_main_menu()
            self.stdscr.refresh()

            try:
                key = self.stdscr.getch()
            except KeyboardInterrupt:
                break

            if key == ord('q'):
                self.save_config()
                self.show_message("Configuration saved!")
                break

            elif key == curses.KEY_UP:
                self.selected_item = max(0, self.selected_item - 1)

            elif key == curses.KEY_DOWN:
                max_item = len(self.config["workspaces"]) - 1
                self.selected_item = min(max_item, self.selected_item + 1)

            elif key == ord('\n') or key == curses.KEY_ENTER:
                self.edit_workspace()

            elif key == ord('a'):
                ws_list = sorted(self.config["workspaces"].keys())
                if self.selected_item < len(ws_list):
                    ws_id = ws_list[self.selected_item]
                    self.add_app(ws_id)

            elif key == ord('s'):
                self.edit_shortcuts()

        return 0


def main_simple():
    """Simple non-curses interface"""
    print(f"{Colors.CYAN}╔═══════════════════════════════════════════════════════════╗{Colors.RESET}")
    print(f"{Colors.CYAN}║  {Colors.MAGENTA}WORKSPACE CONFIGURATION - CYBERPUNK EDITION{Colors.CYAN}             ║{Colors.RESET}")
    print(f"{Colors.CYAN}╚═══════════════════════════════════════════════════════════╝{Colors.RESET}")
    print()

    # Check if config exists
    if CONFIG_FILE.exists():
        print(f"{Colors.GREEN}Configuration file found:{Colors.RESET} {CONFIG_FILE}")
        print()

        # Offer to open in editor
        print(f"{Colors.YELLOW}Options:{Colors.RESET}")
        print(f"  1. Edit in text editor")
        print(f"  2. Launch TUI configurator")
        print(f"  3. Show current config")
        print()

        choice = input(f"{Colors.CYAN}Choice [1-3]:{Colors.RESET} ").strip()

        if choice == "1":
            editor = subprocess.getenv("EDITOR", "nano")
            subprocess.run([editor, str(CONFIG_FILE)])
            return 0
        elif choice == "2":
            return curses.wrapper(lambda stdscr: WorkspaceConfigUI(stdscr).run())
        elif choice == "3":
            with open(CONFIG_FILE) as f:
                print(f.read())
            print()
            input(f"{Colors.CYAN}Press Enter to continue...{Colors.RESET}")
            return 0
    else:
        print(f"{Colors.YELLOW}No configuration found. Creating default...{Colors.RESET}")
        CONFIG_DIR.mkdir(parents=True, exist_ok=True)
        with open(CONFIG_FILE, 'w') as f:
            json.dump(DEFAULT_CONFIG, f, indent=2)
        print(f"{Colors.GREEN}Created:{Colors.RESET} {CONFIG_FILE}")
        print()
        print("Launch TUI configurator? [Y/n]: ", end="")
        choice = input().strip().lower()
        if choice != "n":
            return curses.wrapper(lambda stdscr: WorkspaceConfigUI(stdscr).run())

    return 0


def main():
    import argparse

    parser = argparse.ArgumentParser(description="Workspace Configuration Tool")
    parser.add_argument("--tui", action="store_true", help="Force TUI mode")
    parser.add_argument("--edit", action="store_true", help="Open in text editor")

    args = parser.parse_args()

    if args.edit:
        editor = subprocess.getenv("EDITOR", "nano")
        subprocess.run([editor, str(CONFIG_FILE)])
        return 0

    if args.tui:
        return curses.wrapper(lambda stdscr: WorkspaceConfigUI(stdscr).run())

    return main_simple()


if __name__ == "__main__":
    sys.exit(main())
