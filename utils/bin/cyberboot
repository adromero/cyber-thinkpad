#!/usr/bin/env python3
"""
cyberboot - Neuromancer-Inspired Boot Sequence
Tessier-Ashpool Cyberdeck Suite

A theatrical boot sequence inspired by the Tessier-Ashpool AI constructs
from William Gibson's Neuromancer. Not the Matrix - the original.
"""

import sys
import os
import time
import random
import argparse
import subprocess
from pathlib import Path
from typing import Optional, List, Tuple

# Add lib path
sys.path.insert(0, str(Path(__file__).parent.parent / "lib"))

from colors import Colors

# Boot sequence timing
FAST_DELAY = 0.02
NORMAL_DELAY = 0.05
SLOW_DELAY = 0.15
DRAMATIC_PAUSE = 0.8


def get_hostname() -> str:
    """Get system hostname safely"""
    try:
        with open("/etc/hostname", "r") as f:
            return f.read().strip()
    except (FileNotFoundError, PermissionError):
        return os.uname().nodename


def get_cpu_model() -> str:
    """Get CPU model name"""
    try:
        with open("/proc/cpuinfo", "r") as f:
            for line in f:
                if line.startswith("model name"):
                    return line.split(":")[1].strip()
    except (FileNotFoundError, PermissionError):
        pass
    return "Unknown Processor"


def get_memory_gb() -> int:
    """Get total memory in GB"""
    try:
        with open("/proc/meminfo", "r") as f:
            for line in f:
                if line.startswith("MemTotal"):
                    kb = int(line.split()[1])
                    return kb // (1024 * 1024)
    except (FileNotFoundError, PermissionError):
        pass
    return 0


def get_kernel_version() -> str:
    """Get kernel version"""
    return os.uname().release


def get_uptime() -> str:
    """Get system uptime"""
    try:
        with open("/proc/uptime", "r") as f:
            seconds = float(f.read().split()[0])
            hours = int(seconds // 3600)
            minutes = int((seconds % 3600) // 60)
            return f"{hours}h {minutes}m"
    except (FileNotFoundError, PermissionError):
        return "unknown"


def typewriter(text: str, delay: float = NORMAL_DELAY, end: str = "\n"):
    """Print text with typewriter effect"""
    for char in text:
        print(char, end="", flush=True)
        time.sleep(delay)
    print(end, end="", flush=True)


def glitch_text(text: str, intensity: int = 3) -> str:
    """Add glitch effects to text"""
    glitch_chars = "░▒▓█▄▀■□"
    result = list(text)

    for _ in range(intensity):
        if len(result) > 0:
            pos = random.randint(0, len(result) - 1)
            if result[pos] not in " \n":
                result[pos] = random.choice(glitch_chars)

    return "".join(result)


def scramble_reveal(text: str, iterations: int = 5, delay: float = 0.08):
    """Reveal text through character scrambling"""
    length = len(text)
    scramble_chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*"

    for i in range(iterations):
        revealed = i * (length // iterations)
        line = ""
        for j, char in enumerate(text):
            if j < revealed or char in " :-_.[]()":
                line += char
            else:
                line += random.choice(scramble_chars)
        print(f"\r{line}", end="", flush=True)
        time.sleep(delay)

    print(f"\r{text}")


def progress_bar(label: str, duration: float = 1.0, width: int = 30):
    """Display a progress bar"""
    print(f"{Colors.DIM}{label}{Colors.RESET}", end=" ")

    for i in range(width + 1):
        progress = i / width
        filled = "█" * i
        empty = "░" * (width - i)

        # Color shifts as progress increases
        if progress < 0.3:
            color = Colors.RED
        elif progress < 0.7:
            color = Colors.YELLOW
        else:
            color = Colors.GREEN

        print(f"\r{Colors.DIM}{label}{Colors.RESET} [{color}{filled}{Colors.DIM}{empty}{Colors.RESET}] {int(progress*100):3}%",
              end="", flush=True)
        time.sleep(duration / width)

    print()


def hex_dump_effect(lines: int = 4):
    """Display fake hex dump for atmosphere"""
    for _ in range(lines):
        addr = random.randint(0x7f0000000000, 0x7fffffffffff)
        hex_bytes = " ".join(f"{random.randint(0, 255):02x}" for _ in range(16))
        ascii_repr = "".join(random.choice(".@#$%ABCDEFabcdef0123") for _ in range(16))
        print(f"{Colors.DIM}{addr:016x}  {hex_bytes}  |{ascii_repr}|{Colors.RESET}")
        time.sleep(FAST_DELAY * 2)


def boot_sequence_minimal():
    """Minimal boot sequence for quick starts"""
    hostname = get_hostname()

    print(f"\n{Colors.CYAN}▓▓▓ T-A CONSTRUCT ONLINE ▓▓▓{Colors.RESET}")
    print(f"{Colors.DIM}Node: {hostname}{Colors.RESET}\n")


def boot_sequence_standard():
    """Standard Neuromancer-inspired boot sequence"""
    hostname = get_hostname()
    cpu = get_cpu_model()
    mem_gb = get_memory_gb()
    kernel = get_kernel_version()

    # Initial static
    print()
    for _ in range(3):
        static = "".join(random.choice("░▒▓█ ") for _ in range(60))
        print(f"{Colors.DIM}{static}{Colors.RESET}")
        time.sleep(0.1)

    time.sleep(DRAMATIC_PAUSE)

    # Clear and begin
    print("\033[2J\033[H", end="")

    # Straylight header
    print(f"{Colors.CYAN}╔══════════════════════════════════════════════════════════════╗{Colors.RESET}")
    print(f"{Colors.CYAN}║{Colors.RESET}                                                              {Colors.CYAN}║{Colors.RESET}")
    typewriter(f"{Colors.CYAN}║{Colors.RESET}     {Colors.BOLD}TESSIER-ASHPOOL S.A.{Colors.RESET}                                 {Colors.CYAN}║{Colors.RESET}", FAST_DELAY)
    typewriter(f"{Colors.CYAN}║{Colors.RESET}     {Colors.DIM}STRAYLIGHT SYSTEMS DIVISION{Colors.RESET}                          {Colors.CYAN}║{Colors.RESET}", FAST_DELAY)
    print(f"{Colors.CYAN}║{Colors.RESET}                                                              {Colors.CYAN}║{Colors.RESET}")
    print(f"{Colors.CYAN}╚══════════════════════════════════════════════════════════════╝{Colors.RESET}")

    time.sleep(DRAMATIC_PAUSE)

    # Memory check
    print(f"\n{Colors.DIM}Initializing memory cores...{Colors.RESET}")
    progress_bar("MEMORY", 0.8, 40)

    # CPU initialization
    cpu_short = cpu[:40] + "..." if len(cpu) > 40 else cpu
    print(f"{Colors.DIM}Processor: {cpu_short}{Colors.RESET}")
    progress_bar("CPU INIT", 0.6, 40)

    # Kernel
    print(f"{Colors.DIM}Kernel: {kernel}{Colors.RESET}")
    time.sleep(SLOW_DELAY)

    # Neural interface check
    print(f"\n{Colors.YELLOW}▓ NEURAL INTERFACE CHECK{Colors.RESET}")
    time.sleep(SLOW_DELAY)

    checks = [
        ("Synaptic buffers", True),
        ("ICE protocols", True),
        ("Matrix interface", True),
        ("Construct integrity", True),
    ]

    for check, status in checks:
        status_str = f"{Colors.GREEN}ONLINE{Colors.RESET}" if status else f"{Colors.RED}FAULT{Colors.RESET}"
        print(f"  {Colors.DIM}├─{Colors.RESET} {check}: {status_str}")
        time.sleep(NORMAL_DELAY * 3)

    time.sleep(DRAMATIC_PAUSE)

    # Construct awakening
    print(f"\n{Colors.MAGENTA}▓ CONSTRUCT AWAKENING{Colors.RESET}")
    time.sleep(SLOW_DELAY)

    # The famous Neuromancer quote-inspired text
    lines = [
        "The sky above the port was the color of television,",
        "tuned to a dead channel.",
        "",
        "But here, in the cores, there is only data.",
        "Pure information. The construct stirs.",
    ]

    for line in lines:
        if line:
            typewriter(f"  {Colors.DIM}{line}{Colors.RESET}", FAST_DELAY)
        else:
            print()
        time.sleep(SLOW_DELAY)

    time.sleep(DRAMATIC_PAUSE)

    # Final activation
    print(f"\n{Colors.CYAN}{'═' * 64}{Colors.RESET}")
    scramble_reveal(f"  CONSTRUCT ACTIVE :: NODE [{hostname.upper()}]", 8, 0.06)
    scramble_reveal(f"  MEMORY CORES :: {mem_gb} GB AVAILABLE", 6, 0.05)
    print(f"{Colors.CYAN}{'═' * 64}{Colors.RESET}")

    time.sleep(SLOW_DELAY)

    # Ready prompt
    print(f"\n{Colors.GREEN}▓▓▓ TESSIER-ASHPOOL CONSTRUCT ONLINE ▓▓▓{Colors.RESET}")
    print(f"{Colors.DIM}Awaiting operator input...{Colors.RESET}\n")


def boot_sequence_full():
    """Full theatrical boot sequence with extra drama"""
    hostname = get_hostname()
    cpu = get_cpu_model()
    mem_gb = get_memory_gb()
    kernel = get_kernel_version()

    # Complete blackout then static
    print("\033[2J\033[H", end="")
    time.sleep(DRAMATIC_PAUSE)

    # Static burst
    for _ in range(10):
        for _ in range(3):
            static = "".join(random.choice("░▒▓█ ") for _ in range(70))
            print(f"{Colors.DIM}{static}{Colors.RESET}")
        time.sleep(0.05)

    time.sleep(DRAMATIC_PAUSE)
    print("\033[2J\033[H", end="")

    # Power on self test
    print(f"{Colors.RED}■{Colors.RESET} POWER ON SELF TEST")
    time.sleep(SLOW_DELAY)

    components = [
        "BIOS/UEFI",
        "Memory Controller",
        "CPU Microcode",
        "PCIe Bus",
        "Storage Controller",
        "Network Interface",
    ]

    for comp in components:
        time.sleep(FAST_DELAY * 3)
        print(f"  {Colors.DIM}Testing {comp}...{Colors.RESET}", end=" ")
        time.sleep(SLOW_DELAY)
        print(f"{Colors.GREEN}OK{Colors.RESET}")

    time.sleep(DRAMATIC_PAUSE)

    # Now the standard sequence
    boot_sequence_standard()

    # Extra: Memory sector scan
    print(f"\n{Colors.DIM}Memory sector verification...{Colors.RESET}")
    hex_dump_effect(6)
    print(f"{Colors.GREEN}All sectors nominal.{Colors.RESET}")

    # Straylight connection
    print(f"\n{Colors.PURPLE}Establishing link to Freeside spindle...{Colors.RESET}")
    for i in range(5):
        dots = "." * (i + 1)
        print(f"\r{Colors.PURPLE}Establishing link to Freeside spindle{dots}{Colors.RESET}     ", end="", flush=True)
        time.sleep(SLOW_DELAY)

    print(f"\r{Colors.PURPLE}Establishing link to Freeside spindle... {Colors.GREEN}LINKED{Colors.RESET}     ")

    time.sleep(DRAMATIC_PAUSE)

    # Final message
    print(f"\n{Colors.CYAN}╔══════════════════════════════════════════════════════════════╗{Colors.RESET}")
    print(f"{Colors.CYAN}║{Colors.RESET}  {Colors.BOLD}\"I'm not Wintermute now.{Colors.RESET}                                  {Colors.CYAN}║{Colors.RESET}")
    print(f"{Colors.CYAN}║{Colors.RESET}   {Colors.BOLD}I'm the matrix.{Colors.RESET}                                          {Colors.CYAN}║{Colors.RESET}")
    print(f"{Colors.CYAN}║{Colors.RESET}   {Colors.BOLD}The sum total of all the data ever processed.{Colors.RESET}            {Colors.CYAN}║{Colors.RESET}")
    print(f"{Colors.CYAN}║{Colors.RESET}   {Colors.BOLD}The ghost in the machine.\"{Colors.RESET}                               {Colors.CYAN}║{Colors.RESET}")
    print(f"{Colors.CYAN}║{Colors.RESET}                                                              {Colors.CYAN}║{Colors.RESET}")
    print(f"{Colors.CYAN}║{Colors.RESET}                           {Colors.DIM}— Wintermute/Neuromancer{Colors.RESET}           {Colors.CYAN}║{Colors.RESET}")
    print(f"{Colors.CYAN}╚══════════════════════════════════════════════════════════════╝{Colors.RESET}")

    print()


def shutdown_sequence():
    """Theatrical shutdown sequence"""
    print(f"\n{Colors.YELLOW}▓ CONSTRUCT SHUTDOWN INITIATED{Colors.RESET}")
    time.sleep(SLOW_DELAY)

    steps = [
        "Flushing memory buffers",
        "Disconnecting matrix links",
        "Archiving construct state",
        "Releasing neural locks",
    ]

    for step in steps:
        print(f"  {Colors.DIM}├─ {step}...{Colors.RESET}")
        time.sleep(SLOW_DELAY)

    print(f"\n{Colors.CYAN}The construct sleeps.{Colors.RESET}")
    print(f"{Colors.DIM}In the cores, dreams of electric data.{Colors.RESET}")

    time.sleep(DRAMATIC_PAUSE)

    # Fade out
    for _ in range(5):
        static = "".join(random.choice("░▒▓ ") for _ in range(60))
        print(f"{Colors.DIM}{static}{Colors.RESET}")
        time.sleep(0.1)

    print()


def main():
    parser = argparse.ArgumentParser(
        description="Neuromancer-inspired boot sequence for your cyberdeck"
    )

    parser.add_argument(
        "-m", "--mode",
        choices=["minimal", "standard", "full"],
        default="standard",
        help="Boot sequence mode (default: standard)"
    )

    parser.add_argument(
        "-s", "--shutdown",
        action="store_true",
        help="Run shutdown sequence instead"
    )

    parser.add_argument(
        "-q", "--quiet",
        action="store_true",
        help="Minimal output (same as -m minimal)"
    )

    args = parser.parse_args()

    try:
        if args.shutdown:
            shutdown_sequence()
        elif args.quiet or args.mode == "minimal":
            boot_sequence_minimal()
        elif args.mode == "full":
            boot_sequence_full()
        else:
            boot_sequence_standard()

    except KeyboardInterrupt:
        print(f"\n{Colors.RED}Boot sequence interrupted.{Colors.RESET}")
        sys.exit(1)


if __name__ == "__main__":
    main()
